from flask import Flask, render_template, request, redirect, url_for
import json
import os
from datetime import datetime
from pytz import timezone
import boto3
import uuid
from werkzeug.utils import secure_filename
from markupsafe import Markup

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
JST = timezone('Asia/Tokyo')

# Flaskã‚¢ãƒ—ãƒªåˆæœŸåŒ–
application = Flask(__name__)
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DIARY_FILE = os.path.join(BASE_DIR, 'diary_data.json')
application.secret_key = os.environ.get("FLASK_SECRET_KEY", "secret_dev_key")  # â†ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½

# AWS S3 è¨­å®š
S3_BUCKET = 'april-static'
CLOUDFRONT_URL = 'https://d2sf57sw5vr2iz.cloudfront.net'
s3 = boto3.client('s3')

# S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°
def upload_to_s3(file):
    try:
        filename = secure_filename(file.filename)
        ext = filename.rsplit('.', 1)[1].lower()
        unique_filename = f"images/{uuid.uuid4()}.{ext}"
        s3.upload_fileobj(
            file,
            S3_BUCKET,
            unique_filename,
            ExtraArgs={'ContentType': file.content_type}
        )
        return f"{CLOUDFRONT_URL}/{unique_filename}"
    except Exception as e:
        application.logger.error(f"S3 upload failed: {e}")
        return None

# æ—¥è¨˜ã®èª­ã¿æ›¸ãé–¢æ•°
def load_diary():
    if os.path.exists(DIARY_FILE):
        with open(DIARY_FILE, 'r', encoding='utf-8') as f:
            entries = json.load(f)
        # idãŒãªã‘ã‚Œã°ä»˜ã‘ã‚‹ï¼ˆ0ã‹ã‚‰é€£ç•ªï¼‰
        for i, entry in enumerate(entries):
            if "id" not in entry:
                entry["id"] = i + 1
        return entries
    return []

def save_diary(entries):
    with open(DIARY_FILE, 'w', encoding='utf-8') as f:
        json.dump(entries, f, ensure_ascii=False, indent=2)

# ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆã†ã¥ãã¡ã‚ƒã‚“ç´¹ä»‹ï¼‰
@application.route('/')
def index():
    rabbit = {
        "name": "ã†ã¥ãã¡ã‚ƒã‚“",
        "age": "4æ­³",
        "gender": "å¥³ã®å­",
        "favorite_food": "ä¹¾ç‡¥ã‚Šã‚“ã”",
        "hobby": "ãƒãƒ¢ã‚·ãƒ¼ã¨ã†ã‚“ã“ã‚’æ•£ã‚‰ã‹ã™",
        "image": "0513.jpg"
    }
    return render_template('index.html', rabbit=rabbit)

# æ—¥è¨˜ä¸€è¦§
@application.route('/diary')
def diary():
    entries = load_diary()
    entries.sort(key=lambda e: e.get("id", 0), reverse=True)
    return render_template('diary.html', entries=entries)

# å€‹åˆ¥æ—¥è¨˜
@application.route('/diary/<int:entry_id>')
def diary_entry(entry_id):
    entries = load_diary()
    entry = next((e for e in entries if e.get("id") == entry_id), None)
    if entry:
        return render_template('diary_entry.html', entry=entry)
    return "æ—¥è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", 404

# æ–°è¦æ—¥è¨˜æŠ•ç¨¿
@application.route('/diary/new', methods=['GET', 'POST'])
def new_diary():
    application.logger.info("ğŸš€ /diary/new ã«åˆ°é”ã—ãŸ")

    if request.method == 'POST':
        application.logger.info("ğŸ“ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡")

        title = request.form.get('title', '')
        content = request.form.get('content', '').replace('\r\n', '\n').replace('\r', '\n')
        application.logger.info(f"ã‚¿ã‚¤ãƒˆãƒ«: {title}, æœ¬æ–‡: {content[:30]}")

        image_url = None
        file = request.files.get('image')
        if file and file.filename:
            application.logger.info(f"ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å: {file.filename}")
            image_url = upload_to_s3(file)
            application.logger.info(f"ç”»åƒURL: {image_url}")

        entries = load_diary()
        application.logger.info(f"ç¾åœ¨ã®ä»¶æ•°: {len(entries)}")

        new_entry = {
            'id': max([e.get("id", 0) for e in entries], default=0) + 1,
            'title': title,
            'content': content,
            'date': datetime.now(JST).strftime('%Y-%m-%d %H:%M'),
            'image': image_url
        }
        entries.append(new_entry)

        try:
            save_diary(entries)
            application.logger.info("ğŸ“˜ ä¿å­˜æˆåŠŸ")
        except Exception as e:
            application.logger.error(f"âŒ ä¿å­˜å¤±æ•—: {e}")

        return redirect('/diary')

    return render_template('new_diary.html')

# ç·¨é›†ç”»é¢
@application.route("/diary/<int:entry_id>/edit", methods=["GET", "POST"])
def edit_diary(entry_id):
    entries = load_diary()
    entry = next((e for e in entries if e["id"] == entry_id), None)
    if not entry:
        return "æ—¥è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", 404

    if request.method == "POST":
        entry["title"] = request.form["title"]
        entry["content"] = request.form["content"]
        save_diary(entries)
        return redirect(url_for("diary"))

    return render_template("edit_diary.html", entry=entry)

# å‰Šé™¤å‡¦ç†
@application.route("/diary/<int:entry_id>/delete", methods=["POST"])
def delete_diary(entry_id):
    entries = load_diary()
    entries = [e for e in entries if e["id"] != entry_id]
    save_diary(entries)
    return redirect(url_for("diary"))

# æ”¹è¡Œå¤‰æ›ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆâœ… æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
@application.template_filter('nl2br')
def nl2br_filter(s):
    if s is None:
        return ''
    # å…¨ã¦ã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰ï¼ˆ\r\n, \r, \nï¼‰ã‚’çµ±ä¸€çš„ã«å‡¦ç†
    escaped = Markup.escape(s)
    return Markup(escaped.replace('\r\n', '\n').replace('\r', '\n').replace('\n', '<br>\n'))

# S3ç¢ºèª
@application.route('/test-s3')
def test_s3():
    try:
        result = s3.list_objects_v2(Bucket=S3_BUCKET)
        return f"S3ã«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸï¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ•°: {result.get('KeyCount', 0)}"
    except Exception as e:
        return f"æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}"

# å®Ÿè¡Œ
if __name__ == '__main__':
    application.run(host='0.0.0.0', port=5000)
